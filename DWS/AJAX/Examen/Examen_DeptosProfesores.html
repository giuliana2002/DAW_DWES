<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Examen 1ª Evaluación DWEC</title>
	<style>
		h3 {
			color: red;
		}

		.formProfes {
			visibility: hidden;
			position: absolute;
			top: 20%;
			left: 20%;
			z-index: 11;
			background-color: pink;
			border: 2px solid maroon;
			border-radius: 15px;
			padding: 1em;
			color: red;
		}

		.formProfes div label {
			display: block;
			margin-top: .5em;
		}

		.formProfes .btn {
			display: block;
			margin-top: 1em;
		}

		.ver {
			visibility: visible;
		}

		#deptoDelProfe {
			font-family: "Lucida Console", "Courier New", monospace;
			font-size: 1.2em;
			font-weight: bold;
			color: blue;
		}
	</style>
	<script type="text/javascript">
		const apiUrl = "deptosProfes.php";
		let currentDeptId = -1;
		let currentProfId = -1;

		const ajaxRequest = (url, method, callback = null, params = "") => {
			const xhr = new XMLHttpRequest();
			method = method.toUpperCase();

			if (callback) {
				xhr.onreadystatechange = () => {
					if (xhr.readyState === 4 && xhr.status === 200) {
						callback(JSON.parse(xhr.responseText));
					}
				};
			}

			if (method === "GET") {
				if (params.trim().length > 0) {
					url += "?" + params;
				}
				xhr.open(method, url);
				xhr.send(null);
			} else if (method === "POST") {
				xhr.open(method, url);
				xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
				xhr.send(params);
			}
		};



		const renderTable = (data, tableId) => {
			const tableBody = document.getElementById(tableId);
			tableBody.innerHTML = "";
			data.forEach(item => {
				const row = document.createElement("tr");
				Object.keys(item).forEach(key => {
					if (tableId === "detalle_profesores" && key === "id") {
						return;
					}
					if (tableId === "detalle_profesores" && key === "estado_civil") {
						return;
					}
					const cell = document.createElement("td");
					cell.textContent = item[key];
					row.appendChild(cell);
				});
				if (tableId === "detalle_departamentos") {
					const actionCell = document.createElement("td");
					const viewButton = document.createElement("button");
					viewButton.textContent = "Ver Profesores";
					viewButton.onclick = () => viewProfessors(item.id, item.nombre);
					actionCell.appendChild(viewButton);
					row.appendChild(actionCell);
				} else if (tableId === "detalle_profesores") {
					const deleteCell = document.createElement("td");
					const deleteButton = document.createElement("button");

					deleteButton.textContent = "X";
					deleteButton.onclick = () => deleteProfessor(item.id);
					deleteCell.appendChild(deleteButton);
					row.appendChild(deleteCell);

					const editCell = document.createElement("td");
					const editButton = document.createElement("button");
					editButton.textContent = "X";
					editButton.onclick = () => showEditForm(item);
					editCell.appendChild(editButton);
					row.appendChild(editCell);
				}
				tableBody.appendChild(row);
			});
		};


		const showForm = (formId) => {
			document.getElementById(formId).classList.add("ver");
		};

		const hideForm = (formId) => {
			document.getElementById(formId).classList.remove("ver");
		};

		const addDepartment = () => {
			const nombre = document.getElementById("nombreDepto").value;
			const descripcion = document.getElementById("descripcion").value;

			ajaxRequest(apiUrl, "POST", (data) => renderTable(data, "detalle_departamentos"), JSON.stringify({ servicio: "anadeDepto", nombre, descripcion }));
		};


		const viewProfessors = (deptId, deptName) => {
			currentDeptId = deptId;
			document.getElementById("deptoDelProfe").textContent = deptName;

			ajaxRequest(apiUrl, "POST", (data) => {
				renderTable(data, "detalle_profesores");
			}, JSON.stringify({ servicio: "profesores", id_departamento: deptId }));
		};

		const addProfessor = () => {
			const dni = document.getElementById("dni").value;
			const nombre = document.getElementById("nombre").value;
			const apellidos = document.getElementById("apellidos").value;
			ajaxRequest(apiUrl, "POST", (data) => renderTable(data, "detalle_profesores"), JSON.stringify({ servicio: "anadeProfe", id_departamento: currentDeptId, dni, nombre, apellidos }));
		};

		const deleteProfessor = (profId) => {
			if (confirm(`¿Desea borrar eliminar este profesor?`))
				ajaxRequest(apiUrl, "POST", (data) => renderTable(data, "detalle_profesores"), JSON.stringify({ servicio: "eliminaProfe", id: profId, id_departamento: currentDeptId }));
		};

		const showEditForm = (professor) => {
			currentProfId = professor.id;
			document.getElementById("dniEditar").value = professor.dni;
			document.getElementById("nombreEditar").value = professor.nombre;
			document.getElementById("apellidosEditar").value = professor.apellidos;
			showForm("formProfesEditar");
		};

		const editProfessor = () => {
			const dni = document.getElementById("dniEditar").value;
			const nombre = document.getElementById("nombreEditar").value;
			const apellidos = document.getElementById("apellidosEditar").value;
			ajaxRequest(apiUrl, "POST", (data) => renderTable(data, "detalle_profesores"), JSON.stringify({ servicio: "modificaProfe", id: currentProfId, dni, nombre, apellidos, id_departamento: currentDeptId }));
		};
		window.onload = () => {
			ajaxRequest(apiUrl, "POST", (data) => renderTable(data, "detalle_departamentos"), JSON.stringify({ servicio: "departamentos" }));
			document.getElementById("btNuevaProfe").onclick = () => showForm("formProfes");
			document.getElementById("btCancelar").onclick = () => hideForm("formProfes");
			document.getElementById("btAnade").onclick = () => {
				addProfessor();
				hideForm("formProfes");
			};
			document.getElementById("btCancelarEditar").onclick = () => hideForm("formProfesEditar");
			document.getElementById("btEdita").onclick = () => {
				editProfessor();
				hideForm("formProfesEditar");
			};
			document.getElementById("btNuevoDepto").onclick = () => showForm("formDeptos");
			document.getElementById("btCancelarDepto").onclick = () => hideForm("formDeptos");
			document.getElementById("btAnadeDepto").onclick = () => {
				addDepartment();
				hideForm("formDeptos");
			};
		};

	</script>
</head>

<body>
	<h1>Registro de Usuarios</h1>
	<button class="btn" id="btNuevoDepto" type="button">Nuevo Departamento</button>
	<p>
	<div id="departamentos">
		<table border="1">
			<thead>
				<tr>
					<th>ID</th>
					<th>NOMBRE</th>
					<th>DESCRIPCION</th>
					<th>Acción</th>
				</tr>
			</thead>
			<tbody id="detalle_departamentos"></tbody>
		</table>
	</div>
	</p>

	<div id="formDeptos" class="formProfes">
		<fieldset>
			<legend>Nuevo Departamento</legend>
			<div>
				<label for="nombreDepto">Nombre</label>
				<input type="text" id="nombreDepto" />
			</div>

			<div>
				<label for="descripcion">Descripcion</label>
				<textarea id="descripcion"></textarea>
			</div>
			<div class="btn">
				<button id="btAnadeDepto" type="button">Añadir</button>
				<button id="btCancelarDepto" type="button">Cancelar</button>
			</div>
		</fieldset>
	</div>

	<br />
	<br />
	Tabla de Profesores. Departamento de <span id="deptoDelProfe"></span>:
	<br><br>
	<button class="btn" id="btNuevaProfe" type="button">Nueva profe</button>

	<p>
	<div id="profesores">
		<table border="1">
			<thead>
				<tr>
					<th>ID</th>
					<th>DNI</th>
					<th>NOMBRE</th>
					<th>APELLIDOS</th>
					<th>Eliminar</th>
					<th>Editar</th>
				</tr>
			</thead>
			<tbody id="detalle_profesores"></tbody>
		</table>
	</div>
	</p>

	<div id="formProfes" class="formProfes">
		<fieldset>
			<legend>Alta en el servicio</legend>
			<div>
				<label for="dni">DNI</label>
				<input type="text" id="dni" size="10" maxlength="9" />
			</div>
			<div>
				<label for="nombre">Nombre</label>
				<input type="text" id="nombre" />
			</div>
			<div>
				<label for="apellidos">Apellidos</label>
				<input type="text" id="apellidos" size="40" />
			</div>
			<div class="btn">
				<button id="btAnade" type="button">Añadir</button>
				<button id="btCancelar" type="button">Cancelar</button>
			</div>
		</fieldset>
	</div>

	<div id="formProfesEditar" class="formProfes">
		<fieldset>
			<legend>Editar Profesor</legend>
			<div>
				<label for="dniEditar">DNI</label>
				<input type="text" id="dniEditar" size="10" maxlength="9" />
			</div>
			<div>
				<label for="nombreEditar">Nombre</label>
				<input type="text" id="nombreEditar" />
			</div>
			<div>
				<label for="apellidosEditar">Apellidos</label>
				<input type="text" id="apellidosEditar" size="40" />
			</div>
			<div class="btn">
				<button id="btEdita" type="button">Editar</button>
				<button id="btCancelarEditar" type="button">Cancelar</button>
			</div>
		</fieldset>
	</div>
</body>

</html>