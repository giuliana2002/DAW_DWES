<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8" />
	<title>Ejercicio Listado Personas con Dos Formularios</title>
	<style type="text/css">
		body {
			background-color: #f0f0f0;
			font-family: 'Arial', sans-serif;
			color: #333;
		}

		h3 {
			color: #444;
			text-align: center;
			font-size: 28px;
			margin-top: 20px;
		}

		.formPersonas {
			visibility: hidden;
			position: absolute;
			top: 20%;
			left: 50%;
			transform: translateX(-50%);
			z-index: 11;
			background-color: #fff;
			border: 1px solid #ccc;
			border-radius: 8px;
			padding: 1.5em;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			width: 300px;
		}

		.formPersonas input[type="text"] {
			width: 100%;
			padding: 0.5em;
			margin-top: 0.5em;
			border: 1px solid #ccc;
			border-radius: 4px;
		}

		.formPersonas .btn {
			display: flex;
			justify-content: space-between;
			margin-top: 1.5em;
		}

		.formPersonas .btn button {
			padding: 0.5em 1em;
			border: none;
			border-radius: 4px;
			background-color: #007bff;
			color: white;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		#btNuevaPersona {
			display: block;
			margin: 1em auto;
			padding: 0.5em 1em;
			border: none;
			border-radius: 4px;
			background-color: #28a745;
			color: white;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		#btNuevaPersona:hover {
			background-color: #218838;
		}

		table {
			width: 80%;
			margin: 1em auto;
			border-collapse: collapse;
			background-color: #fff;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		table,
		th,
		td {
			border: 1px solid #ddd;
			padding: 0.5em;
		}

		button {
			padding: 0.5em 1em;
			border: none;
			border-radius: 4px;
			background-color: #007bff;
			color: white;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		button:hover {
			background-color: #0056b3;
		}
	</style>
	<script type="text/javascript">
		var url = "http://localhost/AJAX/lista_personas/servidor.php";

		window.onload = () => {
			peticionAJAX("POST", url, { servicio: "listar" }, (datos) => {
				pintarPersonas(datos);
			});

			document.getElementById("btNuevaPersona").onclick = function () {
				limpiarFormulario("formAgregar");
				
				document.getElementById("formAgregar").style.visibility = "visible";
			};

			document.getElementById("btCancelarAgregar").onclick = function () {
				document.getElementById("formAgregar").style.visibility = "hidden";
			};

			document.getElementById("btCancelarEditar").onclick = function () {
				document.getElementById("formEditar").style.visibility = "hidden";
			};

			document.getElementById("btAnade").onclick = function () {
				aniadirPersonas();
			};

			document.getElementById("btEditar").onclick = function () {
				modificarPersona();
			};
		};

		const aniadirPersonas = () => {
			let ingresar = {
				servicio: "insertar",
				dni: document.querySelector("#dniAgregar").value,
				nombre: document.querySelector("#nombreAgregar").value,
				apellidos: document.querySelector("#apellidosAgregar").value,
			};
			peticionAJAX("POST", url, ingresar, (datos) => {
				pintarPersonas(datos);
				document.getElementById("formAgregar").style.visibility = "hidden";
			});
		};

		function modificarPersona() {
			let ingresar = {
				servicio: "modificar",
				dni: document.querySelector("#dniEditar").value,
				nombre: document.querySelector("#nombreEditar").value,
				apellidos: document.querySelector("#apellidosEditar").value,
				id: document.getElementById("btEditar").dataset.idper
			};
			peticionAJAX("PUT", url, ingresar, (datos) => {
				pintarPersonas(datos);
				document.getElementById("formEditar").style.visibility = "hidden";
			});
		}

		function borrarPersonas() {
			let borrar = {
				servicio: "borrar",
				id: this.dataset.idper,
			};
			if (confirm(`Desea borrar a ${this.dataset.nomper}`)) {
				peticionAJAX("DELETE", url, borrar, (datos) => {
					pintarPersonas(datos);
				});
			}
		}

		function editaPersona() {
			document.querySelector("#dniEditar").value = this.dataset.dni;
			document.querySelector("#nombreEditar").value = this.dataset.nomper;
			document.querySelector("#apellidosEditar").value = this.dataset.apeper;
			document.getElementById("formEditar").style.visibility = "visible";
			document.getElementById("btEditar").dataset.idper = this.dataset.idper;
		}

		function pintarPersonas(datos) {
			let cuerpo = document.querySelector("#filas_tabla");
			cuerpo.innerHTML = "";
			for (persona of datos) {
				var fila = document.createElement("tr");
				for (i in persona) {
					var columna = document.createElement("td");
					columna.innerHTML = persona[i];
					fila.append(columna);
				}

				columna = document.createElement("td");
				let boton = document.createElement("button");
				boton.dataset.idper = persona.ID;
				boton.dataset.nomper = persona.NOMBRE;
				boton.dataset.dni = persona.DNI;
				boton.onclick = borrarPersonas;
				boton.innerText = "Borrar";
				columna.append(boton);
				fila.append(columna);

				columna = document.createElement("td");
				boton = document.createElement("button");
				boton.dataset.idper = persona.ID;
				boton.dataset.nomper = persona.NOMBRE;
				boton.dataset.apeper = persona.APELLIDOS;
				boton.dataset.dni = persona.DNI;
				boton.onclick = editaPersona;
				boton.innerText = "Editar";
				columna.append(boton);

				fila.append(columna);
				cuerpo.append(fila);
			}
		}

		function limpiarFormulario(formulario) {
			document.querySelector(`#${formulario} #dniAgregar`).value = "";
			document.querySelector(`#${formulario} #nombreAgregar`).value = "";
			document.querySelector(`#${formulario} #apellidosAgregar`).value = "";
		}

		const peticionAJAX = (metodo, url, servicio, callback) => {
			const peticion = new XMLHttpRequest();
			peticion.open(metodo, url, true);
			peticion.setRequestHeader("Content-Type", "application/json");
			peticion.send(JSON.stringify(servicio));
			peticion.onreadystatechange = () => {
				if (peticion.readyState == 4 && peticion.status == 200) {
					callback(JSON.parse(peticion.responseText));
				}
			};
		};
	</script>
</head>

<body>
	<h3>Registro de Usuarios con dos formularios</h3>

	<!-- Formulario de agregar nueva persona -->
	<div id="formAgregar" class="formPersonas">
		<fieldset>
			<legend>Agregar Persona </legend>
			<div>
				<label for="dniAgregar">DNI</label>
				<input type="text" id="dniAgregar" size="10" maxlength="9" />
			</div>
			<div>
				<label for="nombreAgregar">Nombre</label>
				<input type="text" id="nombreAgregar" />
			</div>
			<div>
				<label for="apellidosAgregar">Apellidos</label>
				<input type="text" id="apellidosAgregar" size="40" />
			</div>
			<div class="btn">
				<button id="btAnade">AÃ±adir</button>
				<button id="btCancelarAgregar">Cancelar</button>
			</div>
		</fieldset>
	</div>

	<!-- Formulario de editar persona -->
	<div id="formEditar" class="formPersonas">
		<fieldset>
			<legend>Editar Persona</legend>
			<div>
				<label for="dniEditar">DNI</label>
				<input type="text" id="dniEditar" size="10" maxlength="9" />
			</div>
			<div>
				<label for="nombreEditar">Nombre</label>
				<input type="text" id="nombreEditar" />
			</div>
			<div>
				<label for="apellidosEditar">Apellidos</label>
				<input type="text" id="apellidosEditar" size="40" />
			</div>
			<div class="btn">
				<button id="btEditar">Guardar Cambios</button>
				<button id="btCancelarEditar">Cancelar</button>
			</div>
		</fieldset>
	</div>

	<br />
	<button class="btn" id="btNuevaPersona">Nueva persona</button>
	<br><br>
	<table id="tabla_personas" border="1">
		<tr>
			<th>ID</th>
			<th>DNI</th>
			<th>NOMBRE</th>
			<th>APELLIDOS</th>
			<th>Borrar</th>
			<th>Editar</th>
		</tr>
		<tbody id="filas_tabla">
		</tbody>
	</table>

	<br><br>
</body>

</html>